# GPU-enabled docker-compose for NVIDIA GPU transcoding
#
# Prerequisites:
#   1. Install NVIDIA Container Toolkit:
#      https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html
#   2. Verify with: docker run --rm --gpus all nvidia/cuda:12.0-base nvidia-smi
#
# For Intel/AMD (VAAPI), use docker-compose.vaapi.yml instead.

services:
  rustfin:
    build: .
    container_name: rustfin-gpu
    ports:
      - "8096:8096"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - rustfin-config:/config
      - rustfin-cache:/cache
      - rustfin-transcode:/transcode
      - ${RUSTFIN_MEDIA_PATH:-/Users/iwanteague/Media}:/media:ro
    environment:
      - RUSTFIN_ADMIN_PASSWORD=changeme
      - RUST_LOG=info
      - RUSTFIN_DIRECTORY_PICKER_HELPER_URL=${RUSTFIN_DIRECTORY_PICKER_HELPER_URL:-http://host.docker.internal:43110/pick}
      - RUSTFIN_MEDIA_HOST_PATH=${RUSTFIN_MEDIA_PATH:-/Users/iwanteague/Media}
      - RUSTFIN_MEDIA_CONTAINER_ROOT=/media
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

volumes:
  rustfin-config:
  rustfin-cache:
  rustfin-transcode:
